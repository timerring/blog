<!doctype html><html lang=en dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="This article presents a comprehensive implementation of a danmaku rendering algorithm from the ground up, along with a thorough analysis of the danmaku rendering algorithm. The source code is available on GitHub."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta name=keywords content="The component of the danmaku rendering,XML Danmaku File Structure,danmaku info,ASS File Structure,SSA,ASS,Script Info,V4+ Styles,Events,Convert,R2L and BTM danmaku(Normal danmaku),Move Effect,X Position movement,Y Position movement,Pos Effect,Superchat danmaku,File structure,Postion Arrangement Algorithm,Bubble Movement Effect Algorithm,Gift and guard danmaku,File structure,Gift and Guard Danmaku Display Algorithm,The result display,Reference"><meta property="og:url" content="https://blog.timerring.com/posts/implement-danmaku-rendering-algorithm-from-scratch/"><meta property="og:site_name" content="timerring"><meta property="og:title" content="Implement danmaku rendering algorithm from scratch"><meta property="og:description" content="This article presents a comprehensive implementation of a danmaku rendering algorithm from the ground up, along with a thorough analysis of the danmaku rendering algorithm. The source code is available on GitHub."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-03-22T13:13:16+08:00"><meta property="article:tag" content="Python"><meta property="article:tag" content="Danmaku"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/timerring/scratchpad2023/2024/2025-03-23-15-20-16.png"><meta itemprop=name content="Implement danmaku rendering algorithm from scratch"><meta itemprop=description content="This article presents a comprehensive implementation of a danmaku rendering algorithm from the ground up, along with a thorough analysis of the danmaku rendering algorithm. The source code is available on GitHub."><meta itemprop=datePublished content="2025-03-22T13:13:16+08:00"><meta itemprop=dateModified content="2025-03-22T13:13:16+08:00"><meta itemprop=wordCount content="4295"><meta itemprop=image content="https://cdn.jsdelivr.net/gh/timerring/scratchpad2023/2024/2025-03-23-15-20-16.png"><meta itemprop=keywords content="Python,Danmaku"><meta name=twitter:image content="https://cdn.jsdelivr.net/gh/timerring/scratchpad2023/2024/2025-03-23-15-20-16.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Implement danmaku rendering algorithm from scratch"><meta name=twitter:description content="This article presents a comprehensive implementation of a danmaku rendering algorithm from the ground up, along with a thorough analysis of the danmaku rendering algorithm. The source code is available on GitHub."><meta name=twitter:site content="@imjohnhowe"><link rel=canonical href=https://blog.timerring.com/posts/implement-danmaku-rendering-algorithm-from-scratch/><title>Implement danmaku rendering algorithm from scratch | timerring</title>
<link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.b2496f568c7d479e460b580e0e81d4b97841f83539eba8c770dc9f8e1aa7682e.css integrity="sha256-sklvVox9R55GC1gODoHUuXhB+DU566jHcNyfjhqnaC4=" crossorigin=anonymous><script defer src=/flexsearch.min.js></script><script defer src=/en.search.min.43a2e9bb1ccf79dfe1890a72679c724893085ecc99176c38667f0a11617fdcc2.js integrity="sha256-Q6LpuxzPed/hiQpyZ5xySJMIXsyZF2w4Zn8KEWF/3MI=" crossorigin=anonymous></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css integrity=sha384-vKruj+a13U8yHIkAyGgK1J3ArTLzrFGBbBc0tDp4ad/EyewESeXE/Iv67Aj8gKZ0 crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js integrity=sha384-PwRUT/YqbnEjkZO0zZxNqcxACrXe+j766U2amXcgMg5457rve2Y7I6ZJSm2A0mS4 crossorigin=anonymous></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous onload=renderMathInElement(document.body)></script><script defer>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"$",right:"$",display:!1}]})})</script><script async src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js></script><meta name=referrer content="no-referrer-when-downgrade"></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><img src=/favicon.png alt=Logo><span>timerring</span></a></h2><hr><p>Rhythmic trend.</p><div class=book-search><div class=gcse-search></div></div><script async src="https://cse.google.com/cse.js?cx=40782701766144f96"></script><ul><li><a href=/>Dashboard</a></li><li><a href=/posts/>Blogs</a></li><li><a href=/categories/weekly/>Newsletter</a></li><li><a href=/index.xml>RSS</a></li><li><a href=/friends/>Friends</a></li><li><a href=/about/>About</a></li></ul><script>function goToRandomPost(){const e=["/posts/hidden-markov-models/?utm_source=random","/posts/markov-chains/?utm_source=random","/posts/markov-processes/?utm_source=random","/posts/0418-find-the-formula-rendering-issue-of-hugo/?utm_source=random","/posts/multi-platform-builds-docker/?utm_source=random","/posts/0404-The-invitation-only-mechanism-from-clubhouse-to-manus/?utm_source=random","/posts/how-to-use-git-submodule/?utm_source=random","/posts/live-streaming-infra-and-protocols/?utm_source=random","/posts/implement-danmaku-rendering-algorithm-from-scratch/?utm_source=random","/posts/is-there-an-rss-renaissance-in-the-ai-era/?utm_source=random","/posts/stock-prices/?utm_source=random","/posts/possion-processes/?utm_source=random","/posts/docker-with-gpu/?utm_source=random","/posts/stochastic-processes/?utm_source=random","/posts/some-useful-tools/?utm_source=random","/posts/a-shopping-experience-in-pangdonglai-supermarket/?utm_source=random","/posts/langchain-and-rag-best-practices/?utm_source=random","/posts/random-walks/?utm_source=random","/posts/sequences-of-random-variables/?utm_source=random","/posts/parameter-estimation/?utm_source=random","/posts/two-random-variables/?utm_source=random","/posts/further-understanding-of-proc/?utm_source=random","/posts/the-iftop/?utm_source=random","/posts/some-useful-commands-to-share/?utm_source=random","/posts/random-variables/?utm_source=random","/posts/repeated-trials/?utm_source=random","/posts/probability-and-its-axioms/?utm_source=random","/posts/reflections-on-trending-topics/?utm_source=random","/posts/cpu-can-only-see-the-threads/?utm_source=random","/posts/go-common-test/?utm_source=random","/posts/go-concurrency-and-parallelism/?utm_source=random","/posts/go-cheatsheet/?utm_source=random","/posts/video-technology-101/?utm_source=random","/posts/the-main-kind-of-message-queue/?utm_source=random","/posts/the-method-to-manage-traffic/?utm_source=random","/posts/the-different-kind-of-api-design/?utm_source=random","/posts/the-encode-and-decode-in-python/?utm_source=random","/posts/about-the-systemd/?utm_source=random","/posts/the-tips-about-dockerfile/?utm_source=random","/posts/docker-cheatsheet/?utm_source=random","/posts/docker-101/?utm_source=random","/posts/the-instance-class-static-magic-method-in-python/?utm_source=random","/posts/the-review-and-plan-for-bilive/?utm_source=random","/posts/the-overview-of-security/?utm_source=random","/posts/how-to-publish-your-code-as-a-pip-module/?utm_source=random","/posts/some-good-things-to-share-about-the-packages/?utm_source=random","/posts/introduction-to-the-http-and-https-protocol/?utm_source=random","/posts/mail-service-and-protocol/?utm_source=random","/posts/understanding-clash-through-configuration/?utm_source=random","/posts/thinking-about-advertisement-from-an-open-source-perspective/?utm_source=random","/posts/a-brief-introduction-to-dns/?utm_source=random","/posts/real-computer-network/?utm_source=random","/posts/python-generator-iterator-and-decorator/?utm_source=random","/posts/python-underlying-mechanism/?utm_source=random","/posts/python-files-exceptions-and-modules/?utm_source=random","/posts/python-object-oriented-programming/?utm_source=random","/posts/python-cheatsheet/?utm_source=random","/posts/python-function-parameter/?utm_source=random","/posts/python-control-structure/?utm_source=random","/posts/python-composite-data-type/?utm_source=random","/posts/python-basic-data-type/?utm_source=random","/posts/python-basic-syntax-elements/?utm_source=random","/posts/deploy-github-pages-with-gpg-signing/?utm_source=random","/posts/gpg-101/?utm_source=random","/posts/housewarming-2024/?utm_source=random"],t=Math.floor(Math.random()*e.length);window.location.href=e[t]}</script><a class=random onclick=goToRandomPost()>Stroll</a></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu>
</label><strong>timerring</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#the-component-of-the-danmaku-rendering>The component of the danmaku rendering</a></li><li><a href=#xml-danmaku-file-structure>XML Danmaku File Structure</a><ul><li><a href=#danmaku-info>danmaku info</a></li></ul></li><li><a href=#ass-file-structure>ASS File Structure</a><ul><li><a href=#ssa>SSA</a></li><li><a href=#ass>ASS</a><ul><li><a href=#script-info>Script Info</a></li><li><a href=#v4-styles>V4+ Styles</a></li><li><a href=#events>Events</a></li></ul></li></ul></li><li><a href=#convert>Convert</a><ul><li><a href=#r2l-and-btm-danmakunormal-danmaku>R2L and BTM danmaku(Normal danmaku)</a><ul><li><a href=#move-effect>Move Effect</a><ul><li><a href=#x-position-movement>X Position movement</a></li><li><a href=#y-position-movement>Y Position movement</a></li></ul></li><li><a href=#pos-effect>Pos Effect</a></li></ul></li><li><a href=#superchat-danmaku>Superchat danmaku</a><ul><li><a href=#file-structure>File structure</a></li><li><a href=#postion-arrangement-algorithm>Postion Arrangement Algorithm</a></li><li><a href=#bubble-movement-effect-algorithm>Bubble Movement Effect Algorithm</a></li></ul></li><li><a href=#gift-and-guard-danmaku>Gift and guard danmaku</a><ul><li><a href=#file-structure-1>File structure</a></li><li><a href=#gift-and-guard-danmaku-display-algorithm>Gift and Guard Danmaku Display Algorithm</a></li></ul></li></ul></li><li><a href=#the-result-display>The result display</a></li><li><a href=#reference>Reference</a></li></ul></nav><style>.book-toc .book-toc-content a{color:var(--body-font-color)}</style></aside></header><article class=markdown><h1>Implement danmaku rendering algorithm from scratch</h1><h5>March 22, 2025
·
21 min read
<span id=busuanzi_container_page_pv>· Page View: <span id=busuanzi_value_page_pv></span></span></h5><div><a href=/categories/tutorial/ style=color:#000>Tutorial</a></div><div><a href=/tags/python/ style=color:#000>Python</a> <span style=color:#000>| </span><a href=/tags/danmaku/ style=color:#000>Danmaku</a></div><p><img src=https://cdn.jsdelivr.net/gh/timerring/scratchpad2023/2024/2025-03-23-15-20-16.png></p><blockquote class="book-hint info">If you have any questions, feel free to comment below.</blockquote><hr><p>This article presents a comprehensive implementation of a danmaku rendering algorithm from the ground up, along with a thorough analysis of the danmaku rendering algorithm. The source code is available on <a href=https://github.com/timerring/DanmakuConvert target=_blank rel="nofollow noopener">GitHub<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a>.</p><h2 id=the-component-of-the-danmaku-rendering>The component of the danmaku rendering
<a class=anchor href=#the-component-of-the-danmaku-rendering>#</a></h2><p>Normally, a danmaku rendering image is comprised of the following components:</p><ul><li>Superchat message</li><li>Gift message(include premium member joining info)</li><li>Bottom danmakus</li><li>Rolling danmakus</li></ul><p><div class=image-desc><img src=https://cdn.jsdelivr.net/gh/timerring/scratchpad2023/2024/2025-03-23-15-20-16.png alt="The components of the danmaku rendering">
<i>The components of the danmaku rendering</i></div></p><p>So how to implement the danmaku rendering algorithm from scratch? We should know the main format of the danmaku file.</p><h2 id=xml-danmaku-file-structure>XML Danmaku File Structure
<a class=anchor href=#xml-danmaku-file-structure>#</a></h2><p>First, we can analyze the structure of XML danmaku file.</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:#bc7a00>&lt;?xml version=&#39;1.0&#39; encoding=&#39;utf-8&#39;?&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;i&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;chatserver&gt;</span>chat.bilibili.com<span style=color:green;font-weight:700>&lt;/chatserver&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;chatid&gt;</span>0<span style=color:green;font-weight:700>&lt;/chatid&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;mission&gt;</span>0<span style=color:green;font-weight:700>&lt;/mission&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;maxlimit&gt;</span>0<span style=color:green;font-weight:700>&lt;/maxlimit&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;state&gt;</span>0<span style=color:green;font-weight:700>&lt;/state&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;real_name&gt;</span>0<span style=color:green;font-weight:700>&lt;/real_name&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;source&gt;</span>e-r<span style=color:green;font-weight:700>&lt;/source&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;metadata&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;user_name&gt;</span>user_name<span style=color:green;font-weight:700>&lt;/user_name&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;room_id&gt;</span>room_id<span style=color:green;font-weight:700>&lt;/room_id&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;room_title&gt;</span>room_title<span style=color:green;font-weight:700>&lt;/room_title&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;area&gt;</span>area<span style=color:green;font-weight:700>&lt;/area&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;parent_area&gt;</span>parent_area<span style=color:green;font-weight:700>&lt;/parent_area&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;live_start_time&gt;</span>2024-12-01T18:03:59+08:00<span style=color:green;font-weight:700>&lt;/live_start_time&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>&lt;record_start_time&gt;</span>2024-12-01T18:05:02+08:00<span style=color:green;font-weight:700>&lt;/record_start_time&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;/metadata&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;d</span> <span style=color:#7d9029>p=</span><span style=color:#ba2121>&#34;0.000,1,25,5816798,1733047466414,0,73c9f86f,-1189105972&#34;</span> <span style=color:#7d9029>uid=</span><span style=color:#ba2121>&#34;0&#34;</span> <span style=color:#7d9029>user=</span><span style=color:#ba2121>&#34;X***&#34;</span><span style=color:green;font-weight:700>&gt;</span>?<span style=color:green;font-weight:700>&lt;/d&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;d</span> <span style=color:#7d9029>p=</span><span style=color:#ba2121>&#34;0.000,1,25,5816798,1733047471983,0,73c9f86f,-1054085047&#34;</span> <span style=color:#7d9029>uid=</span><span style=color:#ba2121>&#34;0&#34;</span> <span style=color:#7d9029>user=</span><span style=color:#ba2121>&#34;X***&#34;</span><span style=color:green;font-weight:700>&gt;</span>good<span style=color:green;font-weight:700>&lt;/d&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:green;font-weight:700>&lt;/i&gt;</span>
</span></span></code></pre></div><p>The XML file is comprised of main 2 elements:</p><ul><li>metadata: contains the information of the live room or video</li><li>d: contains the danmaku information</li></ul><h3 id=danmaku-info>danmaku info
<a class=anchor href=#danmaku-info>#</a></h3><p>The general of <d>element is as follows:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:green;font-weight:700>&lt;d</span> <span style=color:#7d9029>p=</span><span style=color:#ba2121>&#34; 0.000,     1,    25,5816798,1733047466414,   0,   73c9f86f,-1189105972&#34;</span> <span style=color:#7d9029>uid=</span><span style=color:#ba2121>&#34;0&#34;</span> <span style=color:#7d9029>user=</span><span style=color:#ba2121>&#34;X***&#34;</span><span style=color:green;font-weight:700>&gt;</span>?<span style=color:green;font-weight:700>&lt;/d&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;d</span> <span style=color:#7d9029>p=</span><span style=color:#ba2121>&#34;{time},{type},{size},{color},{timestamp},{pool},{uid_crc32},{row_id}&#34;</span> <span style=color:#7d9029>uid=</span><span style=color:#ba2121>&#34;{uid}&#34;</span> <span style=color:#7d9029>user=</span><span style=color:#ba2121>&#34;{user}&#34;</span><span style=color:green;font-weight:700>&gt;</span>{text}<span style=color:green;font-weight:700>&lt;/d&gt;</span>
</span></span></code></pre></div><ul><li>time: the time of the danmaku show up</li><li>type: the type of the danmaku</li><li>size: the size of the danmaku, 12 tiny，16 very small, 18 small, 25 middle, 36 large, 45 very large, 64 huge</li><li>color: the <strong>decimal</strong> RGB color of the danmaku, eg hexadecimal: <code>#FFFFFF</code> -> decimal: <code>16777215</code></li><li>timestamp: the timestamp of the danmaku</li><li>pool: the danmaku pool type</li><li>uid_crc32: the crc32 hash of the danmaku sender&rsquo;s uid, designed for ignore specific user&rsquo;s danmaku</li><li>row_id: the row id of the danmaku, designed for the history danmaku</li></ul><p>The relationship of type and pool:</p><table><thead><tr><th style=text-align:left>pool\type</th><th style=text-align:left>1</th><th style=text-align:left>4</th><th style=text-align:left>5</th><th style=text-align:left>6</th><th style=text-align:left>7</th><th style=text-align:left>9</th></tr></thead><tbody><tr><td style=text-align:left>0</td><td style=text-align:left>roll</td><td style=text-align:left>bottom</td><td style=text-align:left>top</td><td style=text-align:left>reverse</td><td style=text-align:left>special<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></td><td style=text-align:left>/</td></tr><tr><td style=text-align:left>1</td><td style=text-align:left>/</td><td style=text-align:left>/</td><td style=text-align:left>/</td><td style=text-align:left>/</td><td style=text-align:left>precise<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup></td><td style=text-align:left>/</td></tr><tr><td style=text-align:left>2</td><td style=text-align:left>/</td><td style=text-align:left>/</td><td style=text-align:left>/</td><td style=text-align:left>/</td><td style=text-align:left>/</td><td style=text-align:left><a href=https://bilibili.github.io/bas/#/guide target=_blank rel="nofollow noopener">bas<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a></td></tr></tbody></table><h2 id=ass-file-structure>ASS File Structure
<a class=anchor href=#ass-file-structure>#</a></h2><h3 id=ssa>SSA
<a class=anchor href=#ssa>#</a></h3><p>The <code>SSA</code> is the abbreviation of <code>Sub Station Alpha</code>, which is a subtitle format used in many video players. It can implement more complex subtitle effects than <code>SRT</code>.</p><h3 id=ass>ASS
<a class=anchor href=#ass>#</a></h3><p>The <code>ASS</code> is the abbreviation of <code>Advanced SubStation Alpha</code>, which is the V4 version of <code>SSA</code>.</p><p>The basic structure of ASS file<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup> is as follows:</p><pre tabindex=0><code class=language-ass data-lang=ass>[Script Info]
ScriptType: v4.00+
Collisions: Normal
PlayResX: 720
PlayResY: 1280
Timer: 100.0000
WrapStyle: 2
ScaledBorderAndShadow: yes

[V4+ Styles]
Format: Name, Fontname, Fontsize, PrimaryColour, SecondaryColour, OutlineColour, BackColour, Bold, Italic, Underline, StrikeOut, ScaleX, ScaleY, Spacing, Angle, BorderStyle, Outline, Shadow, Alignment, MarginL, MarginR, MarginV, Encoding

Style: R2L,Microsoft YaHei,38,&amp;H4BFFFFFF,&amp;H00FFFFFF,&amp;H00000000,&amp;H1E6A5149,0,0,0,0,100.00,100.00,0.00,0.00,1,0.0,1.0,8,0,0,0,1
Style: L2R,Microsoft YaHei,38,&amp;H4BFFFFFF,&amp;H00FFFFFF,&amp;H00000000,&amp;H1E6A5149,0,0,0,0,100.00,100.00,0.00,0.00,1,0.0,1.0,8,0,0,0,1
Style: TOP,Microsoft YaHei,38,&amp;H4BFFFFFF,&amp;H00FFFFFF,&amp;H00000000,&amp;H1E6A5149,0,0,0,0,100.00,100.00,0.00,0.00,1,0.0,1.0,8,0,0,0,1
Style: BTM,Microsoft YaHei,38,&amp;H4BFFFFFF,&amp;H00FFFFFF,&amp;H00000000,&amp;H1E6A5149,0,0,0,0,100.00,100.00,0.00,0.00,1,0.0,1.0,8,0,0,0,1
Style: SP,Microsoft YaHei,38,&amp;H00FFFFFF,&amp;H00FFFFFF,&amp;H00000000,&amp;H1E6A5149,0,0,0,0,100.00,100.00,0.00,0.00,1,0.0,1.0,7,0,0,0,1
Style: message_box,Microsoft YaHei,28,&amp;H00FFFFFF,&amp;H00FFFFFF,&amp;H00000000,&amp;H1E6A5149,0,0,0,0,100.00,100.00,0.00,0.00,1,0.0,0.7,7,0,0,0,1

[Events]
Format: Layer, Start, End, Style, Name, MarginL, MarginR, MarginV, Effect, Text
Dialogue: 0,0:00:00.00,0:00:12.00,R2L,,0000,0000,0000,,{\move(735,1,-15,1)}{\c&amp;HDEC158}?
Dialogue: 0,0:00:00.00,0:00:12.00,R2L,,0000,0000,0000,,{\move(751,39,-31,39)}{\c&amp;HDEC158}good
</code></pre><p>From above we can find the ASS file is comprised of 3 parts:</p><ul><li>[Script Info]</li><li>[V4+ Styles]</li><li>[Events]</li></ul><h4 id=script-info>Script Info
<a class=anchor href=#script-info>#</a></h4><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>[Script Info]
</span></span><span style=display:flex><span>ScriptType: v4<span style=color:#666>.00</span><span style=color:#666>+</span>  <span style=color:#408080;font-style:italic># The ass is the v4 version of the ssa</span>
</span></span><span style=display:flex><span>Collisions: Normal  <span style=color:#408080;font-style:italic># The collisions type</span>
</span></span><span style=display:flex><span>PlayResX: <span style=color:#666>720</span> <span style=color:#408080;font-style:italic># The X resolution of the video</span>
</span></span><span style=display:flex><span>PlayResY: <span style=color:#666>1280</span> <span style=color:#408080;font-style:italic># The Y resolution of the video</span>
</span></span><span style=display:flex><span>Timer: <span style=color:#666>100.0000</span> <span style=color:#408080;font-style:italic># This is a percentage, above 100 means the danmaku will display faster and faster.</span>
</span></span><span style=display:flex><span>WrapStyle: <span style=color:#666>2</span> <span style=color:#408080;font-style:italic># Whether to change lines, due to the bilibili restrictions, this value is always 2.</span>
</span></span><span style=display:flex><span>ScaledBorderAndShadow: yes <span style=color:#408080;font-style:italic># Whether to scale the border and shadow of the video with the resolution</span>
</span></span></code></pre></div><p>In the [Script Info] part, the key and changeable parameters are:</p><ul><li>PlayResX: the X resolution of the video, default is <strong>1920</strong></li><li>PlayResY: the Y resolution of the video, default is <strong>1080</strong></li></ul><h4 id=v4-styles>V4+ Styles
<a class=anchor href=#v4-styles>#</a></h4><p>This part is some predefined styles for the [Events] part.</p><pre tabindex=0><code class=language-ass data-lang=ass>[V4+ Styles]
Format: Name, Fontname, Fontsize, PrimaryColour, SecondaryColour, OutlineColour, BackColour, Bold, Italic, Underline, StrikeOut, ScaleX, ScaleY, Spacing, Angle, BorderStyle, Outline, Shadow, Alignment, MarginL, MarginR, MarginV, Encoding

Style: R2L,Microsoft YaHei,38,&amp;H4BFFFFFF,&amp;H00FFFFFF,&amp;H00000000,&amp;H1E6A5149,0,0,0,0,100.00,100.00,0.00,0.00,1,0.0,1.0,8,0,0,0,1
Style: L2R,Microsoft YaHei,38,&amp;H4BFFFFFF,&amp;H00FFFFFF,&amp;H00000000,&amp;H1E6A5149,0,0,0,0,100.00,100.00,0.00,0.00,1,0.0,1.0,8,0,0,0,1
Style: TOP,Microsoft YaHei,38,&amp;H4BFFFFFF,&amp;H00FFFFFF,&amp;H00000000,&amp;H1E6A5149,0,0,0,0,100.00,100.00,0.00,0.00,1,0.0,1.0,8,0,0,0,1
Style: BTM,Microsoft YaHei,38,&amp;H4BFFFFFF,&amp;H00FFFFFF,&amp;H00000000,&amp;H1E6A5149,0,0,0,0,100.00,100.00,0.00,0.00,1,0.0,1.0,8,0,0,0,1
Style: SP,Microsoft YaHei,38,&amp;H00FFFFFF,&amp;H00FFFFFF,&amp;H00000000,&amp;H1E6A5149,0,0,0,0,100.00,100.00,0.00,0.00,1,0.0,1.0,7,0,0,0,1
Style: message_box,Microsoft YaHei,28,&amp;H00FFFFFF,&amp;H00FFFFFF,&amp;H00000000,&amp;H1E6A5149,0,0,0,0,100.00,100.00,0.00,0.00,1,0.0,0.7,7,0,0,0,1
</code></pre><p>Most of the styles can be easily understood.</p><p>In the [V4+ Styles] part, the key and changeable parameters are:</p><ul><li>Fontname: the font name, default is <code>Microsoft YaHei</code></li><li>Fontsize: the font size, default is <code>38</code></li><li>MarginL: the left margin, default is <code>0</code></li><li>MarginR: the right margin, default is <code>0</code></li><li>MarginV: the vertical margin, default is <code>0</code></li></ul><h4 id=events>Events
<a class=anchor href=#events>#</a></h4><pre tabindex=0><code class=language-ass data-lang=ass>[Events]
Format: Layer,   Start,       End, Style, Name, MarginL, MarginR, MarginV, Effect, Text
Dialogue: 0,0:00:00.00,0:00:12.00,   R2L,     ,    0000,    0000,    0000,       ,{\move(735,1,-15,1)}{\c&amp;HDEC158}?
Dialogue: 0,0:00:00.00,0:00:12.00,   R2L,     ,    0000,    0000,    0000,       ,{\move(751,39,-31,39)}{\c&amp;HDEC158}good
</code></pre><p>In the [Events] part, the key and changeable parameters are:</p><ul><li>Layer: the layer of the danmaku</li><li>Start: the start time of the danmaku</li><li>End: the end time of the danmaku</li><li>Style: the style of the danmaku,</li><li>Name, MarginL, MarginR, MarginV, Effect: always empty</li></ul><p>About the <code>Layer</code> parameter:</p><ul><li>The <code>R2L danmaku</code> and <code>Superchat danmaku</code> are in the layer <code>0</code>.</li><li>The <code>BTM danmaku</code> and <code>gift danmaku</code> are in the layer <code>1</code>.</li></ul><p>About the <code>Start</code> and <code>End</code> time:</p><ul><li>By default the scroll time is 12 seconds.</li><li>The fix time of BTM danmaku is 5 seconds.</li></ul><p>About the <code>Style</code> parameter:</p><ul><li>R2L: right to left, which is corresponding to the <code>1</code> danmaku <code>type</code> in the XML file.</li><li>BTM: bottom to top, which is corresponding to the <code>4</code> danmaku <code>type</code> in the XML file.</li><li>message_box: message box, which is corresponding to the <code>&lt;sc></code> or <code>&lt;gift></code> in the XML file.</li></ul><h2 id=convert>Convert
<a class=anchor href=#convert>#</a></h2><p>From above analysis, we should convert the danmaku from XML to ASS.</p><p>So next I will analyze the conversion in terms of specific danmaku.</p><h3 id=r2l-and-btm-danmakunormal-danmaku>R2L and BTM danmaku(Normal danmaku)
<a class=anchor href=#r2l-and-btm-danmakunormal-danmaku>#</a></h3><p>The xml file is as follows:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:green;font-weight:700>&lt;d</span> <span style=color:#7d9029>p=</span><span style=color:#ba2121>&#34; 0.000,     1,    25,5816798,1733047466414,   0,   73c9f86f,-1189105972&#34;</span> <span style=color:#7d9029>uid=</span><span style=color:#ba2121>&#34;0&#34;</span> <span style=color:#7d9029>user=</span><span style=color:#ba2121>&#34;X***&#34;</span><span style=color:green;font-weight:700>&gt;</span>?<span style=color:green;font-weight:700>&lt;/d&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;d</span> <span style=color:#7d9029>p=</span><span style=color:#ba2121>&#34;837.163,    4,    25,5816798,1732882824163,   0,   f201ec3c,51587109&#34;</span> <span style=color:#7d9029>uid=</span><span style=color:#ba2121>&#34;0&#34;</span> <span style=color:#7d9029>user=</span><span style=color:#ba2121>&#34;S***&#34;</span><span style=color:green;font-weight:700>&gt;</span>what？<span style=color:green;font-weight:700>&lt;/d&gt;</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>&lt;d</span> <span style=color:#7d9029>p=</span><span style=color:#ba2121>&#34;{time},{type},{size},{color},{timestamp},{pool},{uid_crc32},{row_id}&#34;</span> <span style=color:#7d9029>uid=</span><span style=color:#ba2121>&#34;{uid}&#34;</span> <span style=color:#7d9029>user=</span><span style=color:#ba2121>&#34;{user}&#34;</span><span style=color:green;font-weight:700>&gt;</span>{text}<span style=color:green;font-weight:700>&lt;/d&gt;</span>
</span></span></code></pre></div><p>The ass file is as follows:</p><pre tabindex=0><code class=language-ass data-lang=ass>Format: Layer,   Start,       End, Style, Name, MarginL, MarginR, MarginV, Effect, Text
Dialogue: 0,0:00:00.00,0:00:12.00,   R2L,     ,    0000,    0000,    0000,       ,{\move(735,1,-15,1)}{\c&amp;HDEC158}?
Dialogue: 1,0:13:57.16,0:14:02.16,   BTM,     ,    0000,    0000,    0000,       ,{\pos(960,1043)}{\c&amp;HDEC158}what？
</code></pre><p>For the normal R2L and BTM danmaku, the <code>Layer</code> is <code>0</code>. <code>Start</code> time is the <code>time</code> in the XML file. <code>End</code> time is the <code>time</code> in the XML file plus 12 seconds(which can be changed). <code>Style</code> is <code>R2L</code> or <code>BTM</code>. <code>Name</code> is empty. <code>MarginL</code> is <code>0000</code>. <code>MarginR</code> is <code>0000</code>. <code>MarginV</code> is <code>0000</code>. <code>Effect</code> is empty.</p><p>Text is the <code>text</code> in the XML file. It contains three parts:</p><ul><li><code>{\move(735,1,-15,1)}</code>: <strong>the Move Effect</strong> for the R2L danmaku, which is the position of the danmaku. The first and second number inside is the initial position(x, y) of the danmaku, and the third and fourth number is the final position(x, y) of the danmaku. The <code>y</code> should be the same. The algorithm I will analyze in the next section.</li><li><code>{\pos(960,1043)}</code>: <strong>the Pos Effect</strong> for the BTM danmaku, which is the position of the danmaku. The number inside is the position(x, y) of the danmaku. The algorithm I will analyze in the next section.</li><li><code>{\c&amp;HDEC158}</code>: the color of the danmaku, which can be converted from the decimal <code>color</code> in the XML file.</li><li><code>text</code>: the text of the danmaku.</li></ul><h4 id=move-effect>Move Effect
<a class=anchor href=#move-effect>#</a></h4><p>The <code>move</code> effect is the most important part of the R2L danmaku.</p><h5 id=x-position-movement>X Position movement
<a class=anchor href=#x-position-movement>#</a></h5><p>The basic algorithm is from the initial position and the final position of the danmaku. We should keep the <code>y</code> position the same. Let&rsquo;s talk about the <code>x</code> position first.</p><ul><li>Initial position: <code>(resolution.x + text_length/2, PositionY)</code></li><li>Final position: <code>(-1 * text_length / 2, PositionY)</code></li></ul><p>So how to get the <code>text_length</code>?</p><p>We should count <code>cnt</code> the every character&rsquo;s length in UTF-8 encoding. So we use the <code>0xC0</code> to judge whether the current byte is the start of a multi-byte character, because <code>110- ----</code> is <code>0xC0</code>, and <code>0x00</code> to <code>0x7F</code> is the ASCII character, which is a single-byte character. Therefore, the second judgment is that it must be less than <code>0x80</code>. If it is not UTF-8 encoding, we here directly use the <code>strlen</code> function.</p><p>So the <code>text_length</code> can be approximated by the following formula:</p><p><code>text_length = cnt * int((fontSizeSet + (fontSizeInXml - 25)) / 1.2);</code></p><p>The <code>fontSizeInXml</code> which is in the XML file is the <code>size</code> of the danmaku. So in the simple version, we can just use the formula below:</p><p><code>text_length = cnt * int((fontSizeSet) / 1.2);</code></p><h5 id=y-position-movement>Y Position movement
<a class=anchor href=#y-position-movement>#</a></h5><p>So how should we arrange the position of <code>y</code>? We should ensure that the next danmaku would not be overlapped with the previous one.</p><p>I think we can return to the problem of the distance between the current danmaku and the previous one. To avoid the situation of catching up, we only need to ensure that the next danmaku in the same track(eg. n) cannot catch up with the previous one(eg. n-1), thus will ensure it cannot catch up with the n-2 indirectly. If it can catch up, we should compare the next danmaku data in the next track.</p><p>First, the total distance of each danmaku is fixed, which is <code>text_length + resolution.X</code>. Then the scrolling time is fixed, I think the default time is 12s, so we can calculate the speed of each danmaku <code>V_i</code>, and each track only needs to store the start time of the last danmaku <code>start_time</code> and the length of the danmaku <code>length</code>.</p><p>Then we need to determine whether the next danmaku B can catch up with the previous danmaku A, first, we need to calculate the distance difference <code>Delta_X</code>. That is, <code>Delta_X = (start_time_B - start_time_A) × V_a - text_length_A / 2 - text_length_B / 2</code>. Of course, for aesthetic reasons, a certain margin distance can be reserved. Then, we judge whether this distance can be covered within the remaining time. The speed difference is <code>Delta_V = V_B - V_A</code>, and the approximate time required for catching up can be calculated as <code>Delta_T = Delta_X / Delta_V</code>. We just need to ensure that <code>Start_time_B - Start_time_A > Delta_T</code> to ensure that the two danmakus will not overlap.</p><p>So, in the end, actually only one array and one formula are needed. Of course, in the case of a large number of danmakus, overlapping may still occur. Therefore, a fallback strategy is also required. This fallback strategy is quite simple. We just need to add a flag during each comparison to save the track number with the largest negative time difference. In this way, even if there is a catch-up situation, the danmakus will meet at the far right of the danmaku area. In the case of a large number of danmakus, the viewing experience can still be guaranteed. This method can theoretically accommodate more non-overlapping danmakus in extreme situations.</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:green;font-weight:700>def</span> <span style=color:#00f>get_position_y</span>(font_size, appear_time, text_length, resolution_x, roll_time, array):
</span></span><span style=display:flex><span>    velocity <span style=color:#666>=</span> (text_length <span style=color:#666>+</span> resolution_x) <span style=color:#666>/</span> roll_time
</span></span><span style=display:flex><span>    best_row <span style=color:#666>=</span> <span style=color:#666>0</span>
</span></span><span style=display:flex><span>    best_bias <span style=color:#666>=</span> <span style=color:green>float</span>(<span style=color:#ba2121>&#34;-inf&#34;</span>)
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>for</span> i <span style=color:#a2f;font-weight:700>in</span> <span style=color:green>range</span>(array<span style=color:#666>.</span>rows):
</span></span><span style=display:flex><span>        previous_appear_time <span style=color:#666>=</span> array<span style=color:#666>.</span>get_time(i)
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>if</span> previous_appear_time <span style=color:#666>&lt;</span> <span style=color:#666>0</span>:
</span></span><span style=display:flex><span>            array<span style=color:#666>.</span>set_time_length(i, appear_time, text_length)
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>return</span> <span style=color:#666>1</span> <span style=color:#666>+</span> i <span style=color:#666>*</span> font_size
</span></span><span style=display:flex><span>        previous_length <span style=color:#666>=</span> array<span style=color:#666>.</span>get_length(i)
</span></span><span style=display:flex><span>        previous_velocity <span style=color:#666>=</span> (previous_length <span style=color:#666>+</span> resolution_x) <span style=color:#666>/</span> roll_time
</span></span><span style=display:flex><span>        delta_velocity <span style=color:#666>=</span> velocity <span style=color:#666>-</span> previous_velocity
</span></span><span style=display:flex><span>        <span style=color:#408080;font-style:italic># abs_velocity = abs(delta_velocity)</span>
</span></span><span style=display:flex><span>        <span style=color:#408080;font-style:italic># The initial difference length</span>
</span></span><span style=display:flex><span>        delta_x <span style=color:#666>=</span> (appear_time <span style=color:#666>-</span> previous_appear_time) <span style=color:#666>*</span> previous_velocity <span style=color:#666>-</span> (
</span></span><span style=display:flex><span>            previous_length <span style=color:#666>+</span> text_length
</span></span><span style=display:flex><span>        ) <span style=color:#666>/</span> <span style=color:#666>2</span>
</span></span><span style=display:flex><span>        <span style=color:#408080;font-style:italic># If the initial difference length is negative, which means overlapped. Skip.</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>if</span> delta_x <span style=color:#666>&lt;</span> <span style=color:#666>0</span>:
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>continue</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>if</span> delta_velocity <span style=color:#666>&lt;=</span> <span style=color:#666>0</span>:
</span></span><span style=display:flex><span>            array<span style=color:#666>.</span>set_time_length(i, appear_time, text_length)
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>return</span> <span style=color:#666>1</span> <span style=color:#666>+</span> i <span style=color:#666>*</span> font_size
</span></span><span style=display:flex><span>        delta_time <span style=color:#666>=</span> delta_x <span style=color:#666>/</span> delta_velocity
</span></span><span style=display:flex><span>        bias <span style=color:#666>=</span> appear_time <span style=color:#666>-</span> previous_appear_time <span style=color:#666>-</span> delta_time
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>if</span> bias <span style=color:#666>&gt;</span> <span style=color:#666>0</span>:
</span></span><span style=display:flex><span>            array<span style=color:#666>.</span>set_time_length(i, appear_time, text_length)
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>return</span> <span style=color:#666>1</span> <span style=color:#666>+</span> i <span style=color:#666>*</span> font_size
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>else</span>:
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>if</span> bias <span style=color:#666>&gt;</span> best_bias:
</span></span><span style=display:flex><span>                best_bias <span style=color:#666>=</span> bias
</span></span><span style=display:flex><span>                best_row <span style=color:#666>=</span> i
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>return</span> <span style=color:#666>1</span> <span style=color:#666>+</span> best_row <span style=color:#666>*</span> font_size
</span></span></code></pre></div><h4 id=pos-effect>Pos Effect
<a class=anchor href=#pos-effect>#</a></h4><p>The <code>pos</code> effect is the most important part of the BTM danmaku. Due to the display of every danmaku is around 5 seconds, so we should make sure this single danmaku would not be overlapped in this period. And if there are other danmaku in this period, we should move the new generated danmaku up. So our core algorithm is to get the <code>PositionY</code> of the danmaku is as belows:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#408080;font-style:italic># Bottom danmaku algorithm</span>
</span></span><span style=display:flex><span><span style=color:green;font-weight:700>def</span> <span style=color:#00f>get_fixed_y</span>(font_size, appear_time, resolution_y, array):
</span></span><span style=display:flex><span>    best_row <span style=color:#666>=</span> <span style=color:#666>0</span>
</span></span><span style=display:flex><span>    best_bias <span style=color:#666>=</span> <span style=color:#666>-</span><span style=color:#666>1</span> <span style=color:#408080;font-style:italic># record the best bias</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>for</span> i <span style=color:#a2f;font-weight:700>in</span> <span style=color:green>range</span>(array<span style=color:#666>.</span>rows):
</span></span><span style=display:flex><span>        previous_appear_time <span style=color:#666>=</span> array<span style=color:#666>.</span>get_time(i)
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>if</span> previous_appear_time <span style=color:#666>&lt;</span> <span style=color:#666>0</span>:
</span></span><span style=display:flex><span>            array<span style=color:#666>.</span>set_time_length(i, appear_time, <span style=color:#666>0</span>)
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>return</span> resolution_y <span style=color:#666>-</span> font_size <span style=color:#666>*</span> (i <span style=color:#666>+</span> <span style=color:#666>1</span>) <span style=color:#666>+</span> <span style=color:#666>1</span> <span style=color:#408080;font-style:italic># return the bottom line of the screen.</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>else</span>:
</span></span><span style=display:flex><span>            delta_time <span style=color:#666>=</span> appear_time <span style=color:#666>-</span> previous_appear_time
</span></span><span style=display:flex><span>            <span style=color:#408080;font-style:italic># if the time gap is larger than 5 seconds(the previous danmaku display time is over),</span>
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>if</span> delta_time <span style=color:#666>&gt;</span> <span style=color:#666>5</span>:  
</span></span><span style=display:flex><span>                <span style=color:#408080;font-style:italic># we can move the new danmaku to this line.</span>
</span></span><span style=display:flex><span>                array<span style=color:#666>.</span>set_time_length(i, appear_time, <span style=color:#666>0</span>)
</span></span><span style=display:flex><span>                <span style=color:green;font-weight:700>return</span> resolution_y <span style=color:#666>-</span> font_size <span style=color:#666>*</span> (i <span style=color:#666>+</span> <span style=color:#666>1</span>) <span style=color:#666>+</span> <span style=color:#666>1</span>
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>else</span>:
</span></span><span style=display:flex><span>                <span style=color:#408080;font-style:italic># if the time gap is less than 5 seconds, we can record this bias and row num,</span>
</span></span><span style=display:flex><span>                <span style=color:#408080;font-style:italic># then continue to the next epoch.</span>
</span></span><span style=display:flex><span>                <span style=color:green;font-weight:700>if</span> delta_time <span style=color:#666>&gt;</span> best_bias:
</span></span><span style=display:flex><span>                    best_bias <span style=color:#666>=</span> delta_time
</span></span><span style=display:flex><span>                    best_row <span style=color:#666>=</span> i
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>return</span> resolution_y <span style=color:#666>-</span> font_size <span style=color:#666>*</span> (best_row <span style=color:#666>+</span> <span style=color:#666>1</span>) <span style=color:#666>+</span> <span style=color:#666>1</span> <span style=color:#408080;font-style:italic># return the best line in the screen.</span>
</span></span></code></pre></div><h3 id=superchat-danmaku>Superchat danmaku
<a class=anchor href=#superchat-danmaku>#</a></h3><h4 id=file-structure>File structure
<a class=anchor href=#file-structure>#</a></h4><p>The super chat xml format is as follows:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span><span style=color:green;font-weight:700>&lt;sc</span> <span style=color:#7d9029>ts=</span><span style=color:#ba2121>&#34;50.000&#34;</span> <span style=color:#7d9029>uid=</span><span style=color:#ba2121>&#34;the_user_id&#34;</span> <span style=color:#7d9029>user=</span><span style=color:#ba2121>&#34;the_user_name&#34;</span> <span style=color:#7d9029>price=</span><span style=color:#ba2121>&#34;30&#34;</span> <span style=color:#7d9029>time=</span><span style=color:#ba2121>&#34;60&#34;</span><span style=color:green;font-weight:700>&gt;</span>This is a superchat<span style=color:green;font-weight:700>&lt;/sc&gt;</span>
</span></span></code></pre></div><ul><li><code>ts</code>: The superchat appears time.</li><li><code>uid</code>: The user id.</li><li><code>user</code>: The user name.</li><li><code>price</code>: The price of the superchat.</li><li><code>time</code>: The display time of the superchat.</li></ul><p>Regarding the specific rules on Bilibili, super chats with different prices will have different display durations and word limitations. The details are as follows<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>:</p><table><thead><tr><th style=text-align:left>price(¥)</th><th style=text-align:left>price range</th><th style=text-align:left>display duration</th><th style=text-align:left>chinese characters limit</th></tr></thead><tbody><tr><td style=text-align:left>30</td><td style=text-align:left>30≤ custom price ＜50</td><td style=text-align:left>60s</td><td style=text-align:left>40</td></tr><tr><td style=text-align:left>50</td><td style=text-align:left>50≤ custom price ＜100</td><td style=text-align:left>2min</td><td style=text-align:left>50</td></tr><tr><td style=text-align:left>100</td><td style=text-align:left>100≤ custom price ＜500</td><td style=text-align:left>5min</td><td style=text-align:left>60</td></tr><tr><td style=text-align:left>500</td><td style=text-align:left>500≤ custom price ＜1000</td><td style=text-align:left>30min</td><td style=text-align:left>80</td></tr><tr><td style=text-align:left>1000</td><td style=text-align:left>1000≤ custom price ＜2000</td><td style=text-align:left>1h</td><td style=text-align:left>90</td></tr><tr><td style=text-align:left>2000</td><td style=text-align:left>custom price ≥2000</td><td style=text-align:left>2h</td><td style=text-align:left>100</td></tr></tbody></table><p>The ass file is as follows:</p><pre tabindex=0><code class=language-ass data-lang=ass>Dialogue: 0,0:00:59.20,0:01:10.00,message_box,,0000,0000,0000,,{\pos(20,826.0)\c&amp;HFFF5ED\p1\bord0\shad0}m 0 19 b 0 9.5 9.5 0 19 0 l 481 0 b 490.5 0 500 9.5 500 19 l 500 78 l 0 78
Dialogue: 0,0:00:59.20,0:01:10.00,message_box,,0000,0000,0000,,{\pos(20,904.0)\p1\c&amp;HB2602A\bord0\shad0}m 0 0 l 500 0 l 500 29 b 500 38.5 490.5 48 481 48 l 19 48 b 9.5 48 0  38.5 0 29 
Dialogue: 1,0:00:59.20,0:01:10.00,message_box,,0000,0000,0000,,{\pos(20,832.0)\c&amp;H653617\b1\bord0\shad0}The user name
Dialogue: 1,0:00:59.20,0:01:10.00,message_box,,0000,0000,0000,,{\pos(20,870.0)\c&amp;H313131\fs30\bord0\shad0}SuperChat CNY 30
Dialogue: 1,0:00:59.20,0:01:10.00,message_box,,0000,0000,0000,,{\pos(20,904.0)\c&amp;HFFFFFF\bord0\shad0}The display time of the superchat.
</code></pre><p>Every superchat danmaku message box is comprised of 5 parts:</p><ul><li>the upper box</li><li>the lower box</li><li>the user name</li><li>the price</li><li>the superchat text</li></ul><h4 id=postion-arrangement-algorithm>Postion Arrangement Algorithm
<a class=anchor href=#postion-arrangement-algorithm>#</a></h4><p>For the upper box and lower box paramaters, I will not show them here, if you are interested, you can refer to the function <code>draw_lower_box</code> and <code>draw_upper_box</code> in my repository for more details, and many drawing parameters are referenced from the <strong>DanmakuFactory</strong><sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup>, very grateful to the author. Here I would like to talk about how to make the superchat message box move according to other superchats appear and disappear.</p><p>As we can see, the superchat show up and disappear in chronological order, so how can we define the superchat position in a specific timespot?</p><p>My solution is: calculate the position of the superchat message box every time the superchat changes its position in its life cycle. The concrete algorithm is as follows:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:green;font-weight:700>def</span> <span style=color:#00f>render_superchat</span>(ass_file, sc_font_size, resolution_y, data):
</span></span><span style=display:flex><span>    <span style=color:#ba2121>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#ba2121>    Render superchat events to the ass file.
</span></span></span><span style=display:flex><span><span style=color:#ba2121>
</span></span></span><span style=display:flex><span><span style=color:#ba2121>    Args:
</span></span></span><span style=display:flex><span><span style=color:#ba2121>        ass_file (str): The path to the ass file.
</span></span></span><span style=display:flex><span><span style=color:#ba2121>        sc_font_size (int): The superchat font size, which is used to calculate some render parameters.
</span></span></span><span style=display:flex><span><span style=color:#ba2121>        resolution_y (int): The resolution y, which is used to calculate the initial y coordinate.
</span></span></span><span style=display:flex><span><span style=color:#ba2121>        data (list): The data to render, which is a list of superchat events.
</span></span></span><span style=display:flex><span><span style=color:#ba2121>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#408080;font-style:italic># get all events</span>
</span></span><span style=display:flex><span>    events <span style=color:#666>=</span> []
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>for</span> i, (
</span></span><span style=display:flex><span>        start,
</span></span><span style=display:flex><span>        end,
</span></span><span style=display:flex><span>        sc_height,
</span></span><span style=display:flex><span>        user_name,
</span></span><span style=display:flex><span>        price,
</span></span><span style=display:flex><span>        text,
</span></span><span style=display:flex><span>        btm_box_height,
</span></span><span style=display:flex><span>        process_record,
</span></span><span style=display:flex><span>    ) <span style=color:#a2f;font-weight:700>in</span> <span style=color:green>enumerate</span>(data):
</span></span><span style=display:flex><span>        events<span style=color:#666>.</span>append((start, <span style=color:#ba2121>&#34;start&#34;</span>, i))
</span></span><span style=display:flex><span>        events<span style=color:#666>.</span>append((end, <span style=color:#ba2121>&#34;end&#34;</span>, i))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#408080;font-style:italic># sort events by time</span>
</span></span><span style=display:flex><span>    events<span style=color:#666>.</span>sort()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#408080;font-style:italic># still alive</span>
</span></span><span style=display:flex><span>    active <span style=color:#666>=</span> []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#408080;font-style:italic># process each event</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>for</span> time, event_type, index <span style=color:#a2f;font-weight:700>in</span> events:
</span></span><span style=display:flex><span>        current_start <span style=color:#666>=</span> data[index][<span style=color:#666>0</span>]
</span></span><span style=display:flex><span>        current_end <span style=color:#666>=</span> data[index][<span style=color:#666>1</span>]
</span></span><span style=display:flex><span>        <span style=color:#408080;font-style:italic># if it is a start event, new superchat appears</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>if</span> event_type <span style=color:#666>==</span> <span style=color:#ba2121>&#34;start&#34;</span>:
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>for</span> active_index <span style=color:#a2f;font-weight:700>in</span> active:
</span></span><span style=display:flex><span>                active_start <span style=color:#666>=</span> data[active_index][<span style=color:#666>0</span>]
</span></span><span style=display:flex><span>                active_end <span style=color:#666>=</span> data[active_index][<span style=color:#666>1</span>]
</span></span><span style=display:flex><span>                <span style=color:#408080;font-style:italic># if the current superchat appears in the duration of the active superchat</span>
</span></span><span style=display:flex><span>                <span style=color:green;font-weight:700>if</span> active_start <span style=color:#666>&lt;=</span> current_start <span style=color:#666>&lt;</span> active_end:
</span></span><span style=display:flex><span>                    <span style=color:#408080;font-style:italic># then it will record the height change of the active superchat</span>
</span></span><span style=display:flex><span>                    data[active_index][<span style=color:#666>7</span>] <span style=color:#666>+=</span> <span style=color:#ba2121>f</span><span style=color:#ba2121>&#34;-</span><span style=color:#b68;font-weight:700>{</span>data[index][<span style=color:#666>2</span>]<span style=color:#b68;font-weight:700>}</span><span style=color:#ba2121>@</span><span style=color:#b68;font-weight:700>{</span>time<span style=color:#b68;font-weight:700>}</span><span style=color:#ba2121> &#34;</span>
</span></span><span style=display:flex><span>            active<span style=color:#666>.</span>append(index)
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>else</span>:
</span></span><span style=display:flex><span>            <span style=color:#408080;font-style:italic># the superchat will disappear, so remove it from the active list first</span>
</span></span><span style=display:flex><span>            active<span style=color:#666>.</span>remove(index)
</span></span><span style=display:flex><span>            <span style=color:#408080;font-style:italic># then check if the current superchat appears in the duration of the active superchat</span>
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>for</span> active_index <span style=color:#a2f;font-weight:700>in</span> active:
</span></span><span style=display:flex><span>                active_start <span style=color:#666>=</span> data[active_index][<span style=color:#666>0</span>]
</span></span><span style=display:flex><span>                active_end <span style=color:#666>=</span> data[active_index][<span style=color:#666>1</span>]
</span></span><span style=display:flex><span>                <span style=color:green;font-weight:700>if</span> active_start <span style=color:#666>&lt;=</span> current_start <span style=color:#666>&lt;</span> active_end <span style=color:#a2f;font-weight:700>and</span> time <span style=color:#666>&lt;</span> active_end:
</span></span><span style=display:flex><span>                    <span style=color:#408080;font-style:italic># if the current superchat disappears in the duration of the active superchat</span>
</span></span><span style=display:flex><span>                    <span style=color:#408080;font-style:italic># then record the height change.</span>
</span></span><span style=display:flex><span>                    data[active_index][<span style=color:#666>7</span>] <span style=color:#666>+=</span> <span style=color:#ba2121>f</span><span style=color:#ba2121>&#34;+</span><span style=color:#b68;font-weight:700>{</span>data[index][<span style=color:#666>2</span>]<span style=color:#b68;font-weight:700>}</span><span style=color:#ba2121>@</span><span style=color:#b68;font-weight:700>{</span>time<span style=color:#b68;font-weight:700>}</span><span style=color:#ba2121> &#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#408080;font-style:italic># then parse the result, and write the superchat to the ass file according to the result</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>for</span> i, (
</span></span><span style=display:flex><span>        start,
</span></span><span style=display:flex><span>        end,
</span></span><span style=display:flex><span>        sc_height,
</span></span><span style=display:flex><span>        user_name,
</span></span><span style=display:flex><span>        price,
</span></span><span style=display:flex><span>        text,
</span></span><span style=display:flex><span>        btm_box_height,
</span></span><span style=display:flex><span>        result,
</span></span><span style=display:flex><span>    ) <span style=color:#a2f;font-weight:700>in</span> <span style=color:green>enumerate</span>(data):
</span></span><span style=display:flex><span>        <span style=color:#408080;font-style:italic># print(f&#34;\nSC {i} ({start}-{end}):&#34;)</span>
</span></span><span style=display:flex><span>        <span style=color:#408080;font-style:italic># Initial y coordinate</span>
</span></span><span style=display:flex><span>        previous_y <span style=color:#666>=</span> resolution_y <span style=color:#666>-</span> sc_font_size <span style=color:#666>*</span> <span style=color:#666>2</span>
</span></span><span style=display:flex><span>        current_y <span style=color:#666>=</span> previous_y <span style=color:#666>-</span> sc_height
</span></span><span style=display:flex><span>        current_time <span style=color:#666>=</span> start
</span></span><span style=display:flex><span>        <span style=color:#408080;font-style:italic># print(f&#34;Time {start}: y = {current_y}, previous_y = {previous_y}&#34;)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#408080;font-style:italic># if the position has changed</span>
</span></span><span style=display:flex><span>        <span style=color:green;font-weight:700>if</span> result:
</span></span><span style=display:flex><span>            changes <span style=color:#666>=</span> result<span style=color:#666>.</span>strip()<span style=color:#666>.</span>split()
</span></span><span style=display:flex><span>            <span style=color:green;font-weight:700>for</span> change <span style=color:#a2f;font-weight:700>in</span> changes:
</span></span><span style=display:flex><span>                delta_y, time <span style=color:#666>=</span> change<span style=color:#666>.</span>split(<span style=color:#ba2121>&#34;@&#34;</span>)
</span></span><span style=display:flex><span>                prev_time <span style=color:#666>=</span> current_time
</span></span><span style=display:flex><span>                current_time <span style=color:#666>=</span> <span style=color:green>float</span>(time)
</span></span><span style=display:flex><span>                <span style=color:#408080;font-style:italic># the shift height</span>
</span></span><span style=display:flex><span>                height_change <span style=color:#666>=</span> <span style=color:green>float</span>(delta_y[<span style=color:#666>1</span>:])
</span></span><span style=display:flex><span>                SuperChat(
</span></span><span style=display:flex><span>                    prev_time,
</span></span><span style=display:flex><span>                    current_time,
</span></span><span style=display:flex><span>                    user_name,
</span></span><span style=display:flex><span>                    price,
</span></span><span style=display:flex><span>                    btm_box_height,
</span></span><span style=display:flex><span>                    current_y,
</span></span><span style=display:flex><span>                    previous_y,
</span></span><span style=display:flex><span>                    text,
</span></span><span style=display:flex><span>                    sc_font_size,
</span></span><span style=display:flex><span>                )<span style=color:#666>.</span>write_superchat(ass_file)
</span></span><span style=display:flex><span>                previous_y <span style=color:#666>=</span> current_y
</span></span><span style=display:flex><span>                <span style=color:green;font-weight:700>if</span> delta_y[<span style=color:#666>0</span>] <span style=color:#666>==</span> <span style=color:#ba2121>&#34;-&#34;</span>:
</span></span><span style=display:flex><span>                    current_y <span style=color:#666>-=</span> height_change
</span></span><span style=display:flex><span>                <span style=color:green;font-weight:700>else</span>:
</span></span><span style=display:flex><span>                    current_y <span style=color:#666>+=</span> height_change
</span></span><span style=display:flex><span>                <span style=color:#408080;font-style:italic># print(f&#34;Time {time}: y = {current_y}, previous_y = {previous_y}&#34;)</span>
</span></span><span style=display:flex><span>        prev_time <span style=color:#666>=</span> current_time
</span></span><span style=display:flex><span>        current_time <span style=color:#666>=</span> end
</span></span><span style=display:flex><span>        SuperChat(
</span></span><span style=display:flex><span>            prev_time,
</span></span><span style=display:flex><span>            current_time,
</span></span><span style=display:flex><span>            user_name,
</span></span><span style=display:flex><span>            price,
</span></span><span style=display:flex><span>            btm_box_height,
</span></span><span style=display:flex><span>            current_y,
</span></span><span style=display:flex><span>            previous_y,
</span></span><span style=display:flex><span>            text,
</span></span><span style=display:flex><span>            sc_font_size,
</span></span><span style=display:flex><span>        )<span style=color:#666>.</span>write_superchat(ass_file)
</span></span></code></pre></div><p>Here I uncommented the print test code, so you can see the parsed result of the <code>sample.xml</code>.</p><pre tabindex=0><code>SC 0 (10.0-70.0):
Time 10.0: y = 1078, previous_y = 1204
Time 50.0: y = 952.0, previous_y = 1078
Time 59.0: y = 826.0, previous_y = 952.0

SC 1 (50.0-110.0):
Time 50.0: y = 1078, previous_y = 1204
Time 59.0: y = 952.0, previous_y = 1078

SC 2 (59.0-119.0):
Time 59.0: y = 1078, previous_y = 1204

SC 3 (185.0-245.0):
Time 185.0: y = 1040, previous_y = 1204
Time 217.0: y = 914.0, previous_y = 1040

SC 4 (217.0-337.0):
Time 217.0: y = 1078, previous_y = 1204
Time 269.0: y = 914.0, previous_y = 1078
Time 303.0: y = 712.0, previous_y = 914.0
Time 329.0: y = 876.0, previous_y = 712.0

SC 5 (269.0-329.0):
Time 269.0: y = 1040, previous_y = 1204
Time 303.0: y = 838.0, previous_y = 1040

SC 6 (303.0-363.0):
Time 303.0: y = 1002, previous_y = 1204
</code></pre><p>Then we have the danmaku position of every timespot, so we can render the super chat in the ass file easily.</p><h4 id=bubble-movement-effect-algorithm>Bubble Movement Effect Algorithm
<a class=anchor href=#bubble-movement-effect-algorithm>#</a></h4><p>But, are these the best display? I think not. If we only consider the position, the video will be too boring, so we should add some animation to the superchat appearance. Think about the superchat like a bubble, it will move up and down according to other superchat appearance and disappearance. The picture will be more suitable for the audience.</p><p>So now we can think about the algorithm of the bubble movement effect. As we talked above, this movement can be implemented by the <code>move</code> effect.</p><p>First of all, the new superchat will appear in the bottom of the screen, so the initial <code>y</code> position is the <code>resolution_y - font_size * 2</code> (We should reserve some space for the gift danmaku, I will introduce them in the next section). And the show up position will be the initial <code>y</code> + the message box height.</p><p>Then, how will the new superchat effect other still alive superchat? At the timespot, others will move up the new superchat height as well. So the move parameter will be like from <code>current_y</code> to <code>current_y - new_superchat_height</code>.</p><p>And if there is a specific superchat disappear, the superchat eariler than it will move down the superchat height. So the move parameter will be like from <code>current_y</code> to <code>current_y + disappear_superchat_height</code>. Then everything makes sense.</p><p>Then we should think about, when should we start the movement? There will be many solutions, but I think add it at the change position time of the superchat is the best choice. And make the movement a specific duration, like 0.2 second.</p><p>So the process will be:</p><ul><li>change position time + 0.2s: make the superchat move effect.</li><li>change position time + 0.2s ~ next change position time: make the superchat pos effect.</li></ul><p>You can check the <code>superchat.py</code> for more details.</p><h3 id=gift-and-guard-danmaku>Gift and guard danmaku
<a class=anchor href=#gift-and-guard-danmaku>#</a></h3><h4 id=file-structure-1>File structure
<a class=anchor href=#file-structure-1>#</a></h4><p>The xml file is as follows:</p><div class=highlight><pre tabindex=0 style=-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-xml data-lang=xml><span style=display:flex><span>    <span style=color:#408080;font-style:italic>&lt;!--&gt;gift danmaku&lt;--&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;gift</span> <span style=color:#7d9029>ts=</span><span style=color:#ba2121>&#34;11.00&#34;</span>    <span style=color:#7d9029>uid=</span><span style=color:#ba2121>&#34;0&#34;</span>      <span style=color:#7d9029>user=</span><span style=color:#ba2121>&#34;xxx&#34;</span>         <span style=color:#7d9029>giftname=</span><span style=color:#ba2121>&#34;情书&#34;</span>         <span style=color:#7d9029>giftcount=</span><span style=color:#ba2121>&#34;1&#34;</span> <span style=color:#7d9029>cointype=</span><span style=color:#ba2121>&#34;金瓜子&#34;</span> <span style=color:#7d9029>price=</span><span style=color:#ba2121>&#34;5200&#34;</span><span style=color:green;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;gift</span> <span style=color:#7d9029>ts=</span><span style=color:#ba2121>&#34;13.00&#34;</span>    <span style=color:#7d9029>uid=</span><span style=color:#ba2121>&#34;0&#34;</span>      <span style=color:#7d9029>user=</span><span style=color:#ba2121>&#34;yyy&#34;</span>         <span style=color:#7d9029>giftname=</span><span style=color:#ba2121>&#34;小花花&#34;</span>       <span style=color:#7d9029>giftcount=</span><span style=color:#ba2121>&#34;1&#34;</span> <span style=color:#7d9029>cointype=</span><span style=color:#ba2121>&#34;金瓜子&#34;</span> <span style=color:#7d9029>price=</span><span style=color:#ba2121>&#34;100&#34;</span><span style=color:green;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;gift</span> <span style=color:#7d9029>ts=</span><span style=color:#ba2121>&#34;{time}&#34;</span>   <span style=color:#7d9029>uid=</span><span style=color:#ba2121>&#34;{uid}&#34;</span>  <span style=color:#7d9029>user=</span><span style=color:#ba2121>&#34;{username}&#34;</span>  <span style=color:#7d9029>giftname=</span><span style=color:#ba2121>&#34;{giftname}&#34;</span>   <span style=color:#7d9029>giftcount=</span><span style=color:#ba2121>&#34;{count}&#34;</span> <span style=color:#7d9029>cointype=</span><span style=color:#ba2121>&#34;金瓜子&#34;</span> <span style=color:#7d9029>price=</span><span style=color:#ba2121>&#34;{price}&#34;</span><span style=color:green;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#408080;font-style:italic>&lt;!--&gt;all guard danmaku&lt;--&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;guard</span> <span style=color:#7d9029>ts=</span><span style=color:#ba2121>&#34;18.000&#34;</span> <span style=color:#7d9029>uid=</span><span style=color:#ba2121>&#34;873268&#34;</span> <span style=color:#7d9029>user=</span><span style=color:#ba2121>&#34;xxx&#34;</span> <span style=color:#7d9029>giftname=</span><span style=color:#ba2121>&#34;舰长&#34;</span> <span style=color:#7d9029>count=</span><span style=color:#ba2121>&#34;1&#34;</span> <span style=color:#7d9029>price=</span><span style=color:#ba2121>&#34;198000&#34;</span> <span style=color:#7d9029>level=</span><span style=color:#ba2121>&#34;3&#34;</span><span style=color:green;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;guard</span> <span style=color:#7d9029>ts=</span><span style=color:#ba2121>&#34;18.000&#34;</span> <span style=color:#7d9029>uid=</span><span style=color:#ba2121>&#34;873268&#34;</span> <span style=color:#7d9029>user=</span><span style=color:#ba2121>&#34;yyy&#34;</span> <span style=color:#7d9029>giftname=</span><span style=color:#ba2121>&#34;提督&#34;</span> <span style=color:#7d9029>count=</span><span style=color:#ba2121>&#34;1&#34;</span> <span style=color:#7d9029>price=</span><span style=color:#ba2121>&#34;1998000&#34;</span> <span style=color:#7d9029>level=</span><span style=color:#ba2121>&#34;2&#34;</span><span style=color:green;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;guard</span> <span style=color:#7d9029>ts=</span><span style=color:#ba2121>&#34;18.000&#34;</span> <span style=color:#7d9029>uid=</span><span style=color:#ba2121>&#34;873268&#34;</span> <span style=color:#7d9029>user=</span><span style=color:#ba2121>&#34;zzz&#34;</span> <span style=color:#7d9029>giftname=</span><span style=color:#ba2121>&#34;总督&#34;</span> <span style=color:#7d9029>count=</span><span style=color:#ba2121>&#34;1&#34;</span> <span style=color:#7d9029>price=</span><span style=color:#ba2121>&#34;19998000&#34;</span> <span style=color:#7d9029>level=</span><span style=color:#ba2121>&#34;1  &#34;</span><span style=color:green;font-weight:700>/&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:green;font-weight:700>&lt;guard</span> <span style=color:#7d9029>ts=</span><span style=color:#ba2121>&#34;{time}&#34;</span> <span style=color:#7d9029>uid=</span><span style=color:#ba2121>&#34;{uid}&#34;</span> <span style=color:#7d9029>user=</span><span style=color:#ba2121>&#34;{username}&#34;</span> <span style=color:#7d9029>giftname=</span><span style=color:#ba2121>&#34;{giftname}&#34;</span> <span style=color:#7d9029>count=</span><span style=color:#ba2121>&#34;{count}&#34;</span> <span style=color:#7d9029>price=</span><span style=color:#ba2121>&#34;{price}&#34;</span> 
</span></span><span style=display:flex><span>    <span style=color:#7d9029>level=</span><span style=color:#ba2121>&#34;{level}&#34;</span><span style=color:green;font-weight:700>/&gt;</span>
</span></span></code></pre></div><p>The ass file is as follows:</p><pre tabindex=0><code class=language-ass data-lang=ass>Format: Layer,     Start,       End,      Style, Name, MarginL, MarginR, MarginV, Effect, Text
Dialogue:   0,0:00:00.20,0:00:02.00,message_box,     ,    0000,    0000,    0000,,{\pos(0,1242)}{\c&amp;H1C7795\b1}{username}:{\c&amp;H1C7795\b0} 粉丝团灯牌 x1
</code></pre><p>Set Layer to 0, Start to <code>time</code> in xml, End <code>time</code> + duration time, Style to <code>message_box</code>, Name to empty, MarginL to 0000, MarginR to 0000, MarginV to 0000, Effect to <code>\pos</code> or <code>\move</code>, Text to the gift message. <code>\move</code> and <code>\pos</code> are same as above. <code>b1</code> and <code>b0</code> are the start and end of the font bold, <code>&amp;H1C7795</code> is the font color.</p><h4 id=gift-and-guard-danmaku-display-algorithm>Gift and Guard Danmaku Display Algorithm
<a class=anchor href=#gift-and-guard-danmaku-display-algorithm>#</a></h4><p>Gift and guard danmaku will be displayed in a box range, the height of the box is two font sizes. Gift and guard danmaku will scroll from bottom to top, and the earliest danmaku will be removed when the number of danmaku exceeds the limit.</p><p>First, parse the xml, find the part that contains &ldquo;gift&rdquo; and &ldquo;guard&rdquo;, and store the information in <code>gift_list</code>. Then, calculate the display time and position of the gift and output the ass file according to these information.</p><p>The key points to note are:</p><ol><li><p>Merge adjacent same danmaku</p><ul><li>Sort all <code>gift</code> by appearance time in ascending order. Then merge the adjacent same danmaku in <code>gift_list</code>.</li><li>The definition of adjacent same danmaku is: the same user, the same gift, and the adjacent time is not more than <code>mrege_interval</code>(default 5s, configurable). The start time of the merged danmaku is the start time of the earliest danmaku, and the end time is the end time of the latest danmaku.</li></ul></li><li><p>Handle different danmaku with the same time</p><ul><li>Since the start time of danmaku from different users may be the same, which will cause display conflicts, so we need to adjust the time of the danmaku to avoid conflicts.</li><li>Traverse all danmaku in chronological order. If the start time of a gift danmaku is the same as or earlier than the previous one, then delay the start time of the danmaku and the end time correspondingly. Delay until the maximum number of danmaku is reached.</li><li>Note that: since the minimum time interval of adjacent gift danmaku is 1s, so the number of delayed danmaku multiplied by the delay time cannot exceed 1s.</li></ul></li><li><p>Handle the display time and position of gift danmaku</p><ul><li>When outputting, the display time and position of gift danmaku need to be adjusted according to the end time of <code>\pos</code>, but if there is a new danmaku joining in the final end time, then <code>\pos</code> needs to end earlier.</li><li>To achieve this adjustment, we check whether there is a danmaku with a start time earlier than the end time of the current gift danmaku in the final end time. If there is, then we will advance the end time of the current gift danmaku to the start time of the next danmaku.</li><li>Use an active danmaku list <code>active_danmaku_list</code> to record the current danmaku that is being displayed. The length of the list should not exceed the maximum number of danmaku that is set. When the list length exceeds the limit, the earliest danmaku should be deleted.</li></ul></li><li><p>Danmaku display and movement transition</p><ul><li>Danmaku movement transition: leave a transition time before each <code>\pos()</code>, for smooth transition from the previous position to the current <code>\pos()</code> position. This transition time can be configured.</li><li>For danmaku that exceeds the display range, add a mask <code>\clip()</code> when it is removed, so that the danmaku only displays the content within the mask. The height of the mask should be equal to the display box height, or twice the font size.</li></ul></li></ol><h2 id=the-result-display>The result display
<a class=anchor href=#the-result-display>#</a></h2><p><img src=https://cdn.jsdelivr.net/gh/timerring/scratchpad2023/2024/2025-03-23-15-38-54.jpg alt></p><h2 id=reference>Reference
<a class=anchor href=#reference>#</a></h2><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>special means: <code>[{x1(0-1)|(px)},{y1},"{Aplha0(0-1)}-{Alpha1}",{Lifetime},"{Text}",{Z_Rotation},{Y_Rotation},{x2},{y2},{Move_Time(ms)},{Delay_Time(ms)},{Outline[01]},"{Fontname}",{Linear_Speedup[01]},["SVG_Path"]]</code>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>precise means: <code>[{x1(0-1)|(px)},{y1},"{Aplha0(0-1)}-{Alpha1}",{Lifetime},"{Text}",{Z_Rotation},{Y_Rotation},{x2},{y2},{Move_Time(ms)},{Delay_Time(ms)},{Outline[01]},"{Fontname}",{Linear_Speedup(Bool)}]</code>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p><a href=https://web.archive.org/web/20210604141133/https://www.douban.com/note/658520175/ target=_blank rel="nofollow noopener">https://web.archive.org/web/20210604141133/https://www.douban.com/note/658520175/<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a>&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p><a href=https://live.bilibili.com/blackboard/live-superchat-intro-web.html target=_blank rel="nofollow noopener">https://live.bilibili.com/blackboard/live-superchat-intro-web.html<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p><a href=https://github.com/hihkm/DanmakuFactory target=_blank rel="nofollow noopener">https://github.com/hihkm/DanmakuFactory<span style=white-space:nowrap><svg width=".7em" height=".7em" viewBox="0 0 21 21"><path d="m13 3 3.293 3.293-7 7 1.414 1.414 7-7L21 11V3z" fill="currentcolor"/><path d="M19 19H5V5h7l-2-2H5c-1.103.0-2 .897-2 2v14c0 1.103.897 2 2 2h14c1.103.0 2-.897 2-2v-5l-2-2v7z" fill="currentcolor"/></span></a>&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div><h2>Related readings</h2><ul><li><a href="/posts/cpu-can-only-see-the-threads/?utm_source=related">CPU can only see the threads</a></li><li><a href="/posts/the-encode-and-decode-in-python/?utm_source=related">The Encode and Decode in Python</a></li><li><a href="/posts/the-instance-class-static-magic-method-in-python/?utm_source=related">The Instance Class Static Magic Method in Python</a></li><li><a href="/posts/how-to-publish-your-code-as-a-pip-module/?utm_source=related">How to Publish Your Code as a Pip Module</a></li><li><a href="/posts/python-generator-iterator-and-decorator/?utm_source=related">Python Generator Iterator and Decorator</a></li></ul><hr><div class=post-nav><a href="https://blog.timerring.com/posts/is-there-an-rss-renaissance-in-the-ai-era/?utm_source=nav">&lt;&lt; prev | Is There an Rss...</a>
<a onclick=goToRandomPost() style=cursor:pointer>Continue strolling
</a><a href="https://blog.timerring.com/posts/live-streaming-infra-and-protocols/?utm_source=nav">Live Streaming... ｜ next >></a></div><hr>If you find this blog useful and want to support my blog, need my skill for something, or have a coffee chat with me, feel free to:<div class=support><a href=https://ko-fi.com/polls/What-is-the-custom-topic-for-the-next-month-C0C219LHQJ class=book-btn target=_blank>Subscribe to participate in blog topics and custom services
</a><a href=https://ko-fi.com/timerring class=book-btn target=_blank>Buy me a coffee</a></div><div style=margin-bottom:8px></div><script>function goToRandomPost(){const e=["/posts/hidden-markov-models/?utm_source=random","/posts/markov-chains/?utm_source=random","/posts/markov-processes/?utm_source=random","/posts/0418-find-the-formula-rendering-issue-of-hugo/?utm_source=random","/posts/multi-platform-builds-docker/?utm_source=random","/posts/0404-The-invitation-only-mechanism-from-clubhouse-to-manus/?utm_source=random","/posts/how-to-use-git-submodule/?utm_source=random","/posts/live-streaming-infra-and-protocols/?utm_source=random","/posts/implement-danmaku-rendering-algorithm-from-scratch/?utm_source=random","/posts/is-there-an-rss-renaissance-in-the-ai-era/?utm_source=random","/posts/stock-prices/?utm_source=random","/posts/possion-processes/?utm_source=random","/posts/docker-with-gpu/?utm_source=random","/posts/stochastic-processes/?utm_source=random","/posts/some-useful-tools/?utm_source=random","/posts/a-shopping-experience-in-pangdonglai-supermarket/?utm_source=random","/posts/langchain-and-rag-best-practices/?utm_source=random","/posts/random-walks/?utm_source=random","/posts/sequences-of-random-variables/?utm_source=random","/posts/parameter-estimation/?utm_source=random","/posts/two-random-variables/?utm_source=random","/posts/further-understanding-of-proc/?utm_source=random","/posts/the-iftop/?utm_source=random","/posts/some-useful-commands-to-share/?utm_source=random","/posts/random-variables/?utm_source=random","/posts/repeated-trials/?utm_source=random","/posts/probability-and-its-axioms/?utm_source=random","/posts/reflections-on-trending-topics/?utm_source=random","/posts/cpu-can-only-see-the-threads/?utm_source=random","/posts/go-common-test/?utm_source=random","/posts/go-concurrency-and-parallelism/?utm_source=random","/posts/go-cheatsheet/?utm_source=random","/posts/video-technology-101/?utm_source=random","/posts/the-main-kind-of-message-queue/?utm_source=random","/posts/the-method-to-manage-traffic/?utm_source=random","/posts/the-different-kind-of-api-design/?utm_source=random","/posts/the-encode-and-decode-in-python/?utm_source=random","/posts/about-the-systemd/?utm_source=random","/posts/the-tips-about-dockerfile/?utm_source=random","/posts/docker-cheatsheet/?utm_source=random","/posts/docker-101/?utm_source=random","/posts/the-instance-class-static-magic-method-in-python/?utm_source=random","/posts/the-review-and-plan-for-bilive/?utm_source=random","/posts/the-overview-of-security/?utm_source=random","/posts/how-to-publish-your-code-as-a-pip-module/?utm_source=random","/posts/some-good-things-to-share-about-the-packages/?utm_source=random","/posts/introduction-to-the-http-and-https-protocol/?utm_source=random","/posts/mail-service-and-protocol/?utm_source=random","/posts/understanding-clash-through-configuration/?utm_source=random","/posts/thinking-about-advertisement-from-an-open-source-perspective/?utm_source=random","/posts/a-brief-introduction-to-dns/?utm_source=random","/posts/real-computer-network/?utm_source=random","/posts/python-generator-iterator-and-decorator/?utm_source=random","/posts/python-underlying-mechanism/?utm_source=random","/posts/python-files-exceptions-and-modules/?utm_source=random","/posts/python-object-oriented-programming/?utm_source=random","/posts/python-cheatsheet/?utm_source=random","/posts/python-function-parameter/?utm_source=random","/posts/python-control-structure/?utm_source=random","/posts/python-composite-data-type/?utm_source=random","/posts/python-basic-data-type/?utm_source=random","/posts/python-basic-syntax-elements/?utm_source=random","/posts/deploy-github-pages-with-gpg-signing/?utm_source=random","/posts/gpg-101/?utm_source=random","/posts/housewarming-2024/?utm_source=random"],t=Math.floor(Math.random()*e.length);window.location.href=e[t]}</script></article><div class=book-comments><div class="book-tabs-content markdown-inner"><div id=tcomment></div><script src=https://giscus.app/client.js data-repo=timerring/blog data-repo-id=R_kgDONeZYZg data-category=Announcements data-category-id=DIC_kwDONeZYZs4ClRWs data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=en crossorigin=anonymous async></script></div></div><footer class=book-footer><div class="flex flex-wrap justify-between"></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script><div class=busuanzi-footer><p style=text-align:center>&copy; 2022 - present <a href=https://github.com/timerring>timerring</a> | PV: <span id=busuanzi_value_site_pv></span> | UV: <span id=busuanzi_value_site_uv></span></p></div></footer><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#the-component-of-the-danmaku-rendering>The component of the danmaku rendering</a></li><li><a href=#xml-danmaku-file-structure>XML Danmaku File Structure</a><ul><li><a href=#danmaku-info>danmaku info</a></li></ul></li><li><a href=#ass-file-structure>ASS File Structure</a><ul><li><a href=#ssa>SSA</a></li><li><a href=#ass>ASS</a><ul><li><a href=#script-info>Script Info</a></li><li><a href=#v4-styles>V4+ Styles</a></li><li><a href=#events>Events</a></li></ul></li></ul></li><li><a href=#convert>Convert</a><ul><li><a href=#r2l-and-btm-danmakunormal-danmaku>R2L and BTM danmaku(Normal danmaku)</a><ul><li><a href=#move-effect>Move Effect</a><ul><li><a href=#x-position-movement>X Position movement</a></li><li><a href=#y-position-movement>Y Position movement</a></li></ul></li><li><a href=#pos-effect>Pos Effect</a></li></ul></li><li><a href=#superchat-danmaku>Superchat danmaku</a><ul><li><a href=#file-structure>File structure</a></li><li><a href=#postion-arrangement-algorithm>Postion Arrangement Algorithm</a></li><li><a href=#bubble-movement-effect-algorithm>Bubble Movement Effect Algorithm</a></li></ul></li><li><a href=#gift-and-guard-danmaku>Gift and guard danmaku</a><ul><li><a href=#file-structure-1>File structure</a></li><li><a href=#gift-and-guard-danmaku-display-algorithm>Gift and Guard Danmaku Display Algorithm</a></li></ul></li></ul></li><li><a href=#the-result-display>The result display</a></li><li><a href=#reference>Reference</a></li></ul></nav><style>.book-toc .book-toc-content a{color:var(--body-font-color)}</style></div></aside></main></body></html>